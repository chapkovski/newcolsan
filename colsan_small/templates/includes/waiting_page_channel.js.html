<script>
    var SECOND = 1000;
    var ws_scheme = window.location.protocol == "https:" ? "wss" : "ws";
    var wpsocket = new WebSocket(ws_scheme + '://' + window.location.host + "/watcher/group/{{ group.pk }}/participant/{{participant.code}}/player/{{player.pk}}");

    $(function () {


        initWebSocket();

        function initWebSocket() {

            // Handle any errors that occur.
            wpsocket.onerror = function (error) {
                console.log('WebSocket Error: ' + error);
            };

            // Show a connected message when the WebSocket is opened.
            wpsocket.onopen = function (event) {
                console.log('connected to oTree');
                if (wpsocket.readyState == WebSocket.OPEN) {
                    msg = JSON.stringify({'update_request': true});
                    wpsocket.send(msg);

                }
                ;

            };
            // Handle messages sent by the server.
            wpsocket.onmessage = function (event) {
                {#                var obj = JSON.parse(event.data);#}
                {#                console.log(obj);#}
                console.log('message received!', event.data)
                var obj= JSON.parse(event.data)
                if (obj.not_enough_players_in_subsession) {
                  $('form').submit();
                };


            };


            // Show a disconnected message when the WebSocket is closed.
            wpsocket.onclose = function (event) {
                console.log('disconnected from oTree');
            };
        };
        setInterval(function () {
            if (wpsocket.readyState == WebSocket.OPEN) {
                msg = JSON.stringify({'update_request': true});
                wpsocket.send(msg);

            }
            ;
        }, 1 * SECOND);
    });


</script>
